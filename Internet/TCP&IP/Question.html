<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>为什么需要三次握手? | Epoch</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./assets/img/logo.ico">
    <meta name="description" content="Epoch&#39;s Blog">
    <meta name="author" content="Epoch">
    <meta name="keywords" content="Epochs Blog Basted On VuePress.">
    
    <link rel="preload" href="/blog/assets/css/0.styles.19413b44.css" as="style"><link rel="preload" href="/blog/assets/js/app.a976d4b9.js" as="script"><link rel="preload" href="/blog/assets/js/2.077fc20b.js" as="script"><link rel="preload" href="/blog/assets/js/14.375a22b6.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.c59a72b7.js"><link rel="prefetch" href="/blog/assets/js/11.2f51997e.js"><link rel="prefetch" href="/blog/assets/js/12.4c6b6d39.js"><link rel="prefetch" href="/blog/assets/js/13.8c9bf63c.js"><link rel="prefetch" href="/blog/assets/js/15.630ac74c.js"><link rel="prefetch" href="/blog/assets/js/16.f9efd192.js"><link rel="prefetch" href="/blog/assets/js/17.710968ef.js"><link rel="prefetch" href="/blog/assets/js/18.e98248c3.js"><link rel="prefetch" href="/blog/assets/js/19.4dca1550.js"><link rel="prefetch" href="/blog/assets/js/20.ed86343f.js"><link rel="prefetch" href="/blog/assets/js/21.501b2f8f.js"><link rel="prefetch" href="/blog/assets/js/22.d3b58b1c.js"><link rel="prefetch" href="/blog/assets/js/23.9bf8a256.js"><link rel="prefetch" href="/blog/assets/js/24.9b3b0f9c.js"><link rel="prefetch" href="/blog/assets/js/25.2f925885.js"><link rel="prefetch" href="/blog/assets/js/26.1bf62e76.js"><link rel="prefetch" href="/blog/assets/js/27.3f7bc42a.js"><link rel="prefetch" href="/blog/assets/js/28.8bb4c4dd.js"><link rel="prefetch" href="/blog/assets/js/29.c6ffb896.js"><link rel="prefetch" href="/blog/assets/js/3.87def374.js"><link rel="prefetch" href="/blog/assets/js/30.98fc8e51.js"><link rel="prefetch" href="/blog/assets/js/31.7f306c76.js"><link rel="prefetch" href="/blog/assets/js/32.bf1c9517.js"><link rel="prefetch" href="/blog/assets/js/33.7e1a42c9.js"><link rel="prefetch" href="/blog/assets/js/34.49813caa.js"><link rel="prefetch" href="/blog/assets/js/35.8e496e16.js"><link rel="prefetch" href="/blog/assets/js/36.c394458b.js"><link rel="prefetch" href="/blog/assets/js/37.409d9fcc.js"><link rel="prefetch" href="/blog/assets/js/38.4970fb9b.js"><link rel="prefetch" href="/blog/assets/js/4.4e1a7e2a.js"><link rel="prefetch" href="/blog/assets/js/5.f2ca250f.js"><link rel="prefetch" href="/blog/assets/js/6.db1d3ebc.js"><link rel="prefetch" href="/blog/assets/js/7.5a85f1a5.js"><link rel="prefetch" href="/blog/assets/js/8.1dbfb293.js"><link rel="prefetch" href="/blog/assets/js/9.168f1830.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.19413b44.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="./assets/img/logo.png" alt="Epoch" class="logo"> <span class="site-name can-hide">Epoch</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/CPP/C++ Primer.html" class="nav-link">
  CPP
</a></div><div class="nav-item"><a href="/blog/MySQL/" class="nav-link">
  MySQL
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Internet" class="dropdown-title"><span class="title">Internet</span> <span class="arrow down"></span></button> <button type="button" aria-label="Internet" class="mobile-dropdown-title"><span class="title">Internet</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/Internet/Frame.html" class="nav-link">
  Frame
</a></li><li class="dropdown-item"><!----> <a href="/blog/Internet/HTTP/Http.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/blog/Internet/TCP&amp;IP/IP.html" class="nav-link">
  TCP&amp;IP
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="others" class="dropdown-title"><span class="title">others</span> <span class="arrow down"></span></button> <button type="button" aria-label="others" class="mobile-dropdown-title"><span class="title">others</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/others/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/Binary Tree Traversal.html" class="nav-link">
  Binary Tree Traversal
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/CPP/C++ Primer.html" class="nav-link">
  CPP
</a></div><div class="nav-item"><a href="/blog/MySQL/" class="nav-link">
  MySQL
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Internet" class="dropdown-title"><span class="title">Internet</span> <span class="arrow down"></span></button> <button type="button" aria-label="Internet" class="mobile-dropdown-title"><span class="title">Internet</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/Internet/Frame.html" class="nav-link">
  Frame
</a></li><li class="dropdown-item"><!----> <a href="/blog/Internet/HTTP/Http.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/blog/Internet/TCP&amp;IP/IP.html" class="nav-link">
  TCP&amp;IP
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="others" class="dropdown-title"><span class="title">others</span> <span class="arrow down"></span></button> <button type="button" aria-label="others" class="mobile-dropdown-title"><span class="title">others</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/others/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/others/Binary Tree Traversal.html" class="nav-link">
  Binary Tree Traversal
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>TCP&amp;IP</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/Internet/TCP&amp;IP/" aria-current="page" class="sidebar-link">Internet</a></li><li><a href="/blog/Internet/TCP&amp;IP/IP.html" class="sidebar-link">IP地址</a></li><li><a href="/blog/Internet/TCP&amp;IP/Question.html" aria-current="page" class="active sidebar-link">为什么需要三次握手?</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/Internet/TCP&amp;IP/Question.html#为什么需要三次握手" class="sidebar-link">为什么需要三次握手?</a></li><li class="sidebar-sub-header"><a href="/blog/Internet/TCP&amp;IP/Question.html#为什么需要四次挥手" class="sidebar-link">为什么需要四次挥手？</a></li></ul></li><li><a href="/blog/Internet/TCP&amp;IP/TCP.html" class="sidebar-link">TCP</a></li><li><a href="/blog/Internet/TCP&amp;IP/图解TCP&amp;IP.html" class="sidebar-link">图解TCP/IP</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="为什么需要三次握手"><a href="#为什么需要三次握手" class="header-anchor">#</a> <strong>为什么需要三次握手?</strong></h2> <ol><li>阻⽌重复历史连接的初始化（主因)
<ol><li>当旧的SYN报⽂先到达服务端，服务端回⼀个ACK+SYN报⽂</li> <li>客户端收到后可以根据⾃身的上下⽂，判断这是⼀个历史连接（序列号过期或超时），那么客户端就会发送 RST 报⽂给服务端，表示中⽌这⼀次连接。</li> <li>两次握⼿在收到服务端的响应后开始发⽣数据，不能判断当前连接是否是历史连接。 三次握⼿可以在客户端准备发送第三次报⽂时，客户端因有⾜够的上下⽂来判断当前连接是否是历史连接</li></ol></li> <li>同步双⽅的初始序列号
<ol><li>⼀来⼀回，才能确保双⽅的初始序列号能被可靠的同步</li> <li>两次握⼿只保证了⼀⽅的初始序列号能被对⽅成功接收，没办法保证双⽅的初始序列号都能被确认接收。</li></ol></li> <li>避免资源浪费
<ol><li>两次握⼿会造成消息滞留情况下，服务器重复接受⽆⽤SYN 报⽂，⽽造成重复分配资源.</li> <li>只有两次握⼿时，如果客户端的SYN请求连接在⽹络中阻塞，客户端没有收到服务端的ACK报⽂，会重新发送 SYN。</li> <li>由于没有第三次握⼿，服务器不清楚客户端是否收到了⾃⼰发送的建⽴连接的 ACK 确认信号，所以每收到⼀ 个 SYN 就只能先主动建⽴⼀个连接。</li></ol></li></ol> <p><strong>第三次握手Client发送ACK后, 若丢包,  Server没进入ESTABLISHED状态, 而Client发送数据, 会发生什么?</strong></p> <ul><li><p>Server发送SYN-ACK报文后会进入TCP重传计时, 超时则重发SYN-ACK</p></li> <li><p>若此时Client直接发送数据, Server会发送RST报文关闭TCP连接.</p></li></ul> <p><strong>三次握手过程中可以携带数据吗?</strong></p> <ul><li><p>其实第三次握手的时候，是可以携带数据的。但是，<strong>第一次、第二次握手不可以携带数据</strong>。</p></li> <li><p>为什么这样呢?大家可以想一个问题，假如第一次握手可以携带数据的话，如果有人要恶意攻击服务器，那他每次都在第一次握手中的 SYN 报文中放入大量的数据。因为攻击者根本就不理服务器的接收、发送能力是否正常，然后疯狂着重复发 SYN 报文的话，这会让服务器花费很多时间、内存空间来接收这些报文。</p></li></ul> <p><strong>如果仅采用用两次握手, 只要Server发出ACK到Client接收, 就建立连接?</strong></p> <ul><li>如果网络拥堵, Client之前发送的失效ACK在网络滞留,后再发送给Server, Server接收到直接进入<code>ESTABLISHED</code>, 而此时Client已经<code>CLOSED</code>, 白白等待时间, 浪费资源.</li></ul> <p><strong>SYN攻击: 伪造不同IP发送SYN报文, 使得Server的半连接队列占满, 避免方式?</strong></p> <ol><li>扩大半连接队列</li> <li>缩短服务端超时重传时间, 使Server尽早丢弃⽆⽤连接.</li> <li>当半连接队列满时，启动syn cookie,后续连接不进⼊半连接队列，⽽是计算⼀个cookie值，作为请求报⽂序列号发 送给客户端，如果服务端收到客户端确认报⽂，会检查ack包合法性，如果合法直接加⼊到accept队列.</li></ol> <p><strong>为什么SYN需要消耗一个序号?</strong></p> <ul><li><p><a href="https://stackoverflow.com/questions/2352524/why-does-a-syn-or-fin-bit-in-a-tcp-segment-consume-a-byte-in-the-sequence-number/2399224?r=SearchResults#2399224" target="_blank" rel="noopener noreferrer">networking - Why does a SYN or FIN bit in a TCP segment consume a byte in the sequence number space? - Stack Overflow<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>原因是 SYN 和 FIN 信号都是需要 acknowledgement 的，也就是你必须回复这个信号，如果它不占有一个字节的话，要如何判断你是回复这个信号还是回复这个信号之前的包呢？</p> <p>例如：如果 FIN 信号不占用一个字节，回复 FIN 的 ack 包就可能被误认为是回复之前的数据包被重新发送了一次，第二次挥手无法完成，连接也就无法正常关闭了。</p></li></ul> <h2 id="为什么需要四次挥手"><a href="#为什么需要四次挥手" class="header-anchor">#</a> <strong>为什么需要四次挥手？</strong></h2> <ul><li>这是因为 TCP 不允许连接处于<code>半打开状态</code>时就单向传输数据，所以在三次握手建立连接时，服务器会把 ACK 和 SYN 放在一起发给客户端，其中，ACK 用来打开客户端的发送通道，SYN 用来打开服务器的发送通道。这样，原本的四次握手就降为三次握手了。</li> <li>但是当连接处于<code>半关闭状态</code>时，TCP 是允许单向传输数据的。为便于理解，我们把先关闭连接的一方叫做主动方，后关闭连接的一方叫做被动方。当主动方关闭连接时，被动方仍然可以在不调用 close 函数的状态下，长时间发送数据，此时连接处于<strong>半关闭状态</strong>。这一特性是 TCP 的<code>双向通道互相独立所致</code>，却也使得关闭连接必须通过四次挥手才能做到。</li> <li>第⼀次ACK应答报⽂可以省略，因为下⼀个报⽂段携带了ACK信息，ACK是否出现取决于延迟确认特性。</li> <li>延迟确认：即接收⽅收到包后，如果暂时没有内容回复给发送⽅，则延迟⼀段时间再确认，假如在这个时间范 围内刚好有数据需要传输，则和确认包⼀起回复。这种也被称为数据捎带。延迟确认只是减轻⽹络负担，未必 可以提升⽹络性能，有些情况下反⽽会影响性能.</li></ul> <p><strong>为什么 TIME_WAIT 等待的时间是 2MSL？</strong></p> <ol><li>MSL是 Maximum Segment Lifetime，报⽂最⼤⽣存时间，它是任何报⽂在⽹络上存在的最⻓时间，超过这 个时间报⽂将被丢弃。</li> <li>等待MSL两倍：⽹络中可能存在发送⽅的数据包，当这些发送⽅的数据包被接收⽅处理后⼜会向对⽅发送响 应，所以⼀来⼀回需要等待 2 倍的时间。</li> <li>2MSL 的时间是从客户端接收到 FIN 后发送 ACK 开始计时的。如果在 TIME-WAIT 时间内，因为客户端的 ACK 没有传输到服务端，客户端⼜接收到了服务端᯿发的 FIN 报⽂，那么 2MSL 时间将重新计时.</li></ol> <p><strong>为什么需要 TIME_WAIT 状态？</strong></p> <ol><li>防止<strong>已失效的连接请求报文段</strong>出现在新的连接中.客户端在发送完最后一个<code>ACK 报文</code>后，再经过时间<code>2MSL</code>，就可以使由于网络不通畅产生的滞留报文段失效.</li> <li>最后一次的ACK丢包, Server未能关闭连接, 继而重发FIN, 正常的新连接可能因此关闭. 所以<strong>TIME_WAIT状态就是用来重发可能丢失的ACK报文</strong>.</li></ol> <p><strong>TIME_WAIT 过多有什么危害？</strong></p> <ol><li>内存资源占⽤；</li> <li>对端⼝资源的占⽤，⼀个 TCP 连接⾄少消耗⼀个本地端⼝；可能无端口剩余, 无法创建新连接.</li></ol> <p>​	<strong>解决办法</strong>: 打开系统的TIMEWAIT重用和快速回收</p> <ul><li>修改TIME_WAIT连接状态的上限值</li></ul> <ul><li>启动快速回收机制</li> <li>开启复用机制</li> <li>修改短连接为长连接方式</li> <li>由客户端来主动断开连接</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/6/2022, 8:45:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/Internet/TCP&amp;IP/IP.html" class="prev">
        IP地址
      </a></span> <span class="next"><a href="/blog/Internet/TCP&amp;IP/TCP.html">
        TCP
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.a976d4b9.js" defer></script><script src="/blog/assets/js/2.077fc20b.js" defer></script><script src="/blog/assets/js/14.375a22b6.js" defer></script>
  </body>
</html>
